server
{
listen 80;
server_name rpg.su;
set $root_path '/var/www/html';
	root $root_path;
	index index.php;
	error_page 404 /404.html;
	charset utf-8; # Кодировка сервера

	#закрываем доступ к файлу с логином/хэшем пароля
	location ~* /\.ht
	{ 
		return 404;
	}
	#закрытиe выполнения файлов фрэймворка и статики папок
	location ~* /(?:application|system)/.*\.*$
 	{
		return 404;
	}
	location /
	{
		#перенаправляет /контроллер/метод на index.php
		try_files $uri $uri/ /index.php;
	}

	#выполняет, а не предлагает скачать php файл
	location ~ \.php$ 
	{
		try_files $uri =404;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass php:9000;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param PHP_ADMIN_VALUE "upload_max_filesize=4M \n post_max_size=4M \n error_reporting=E_ALL \n date.timezone=Europe/Moscow";
	}

#Закрытие доступа к файлам из вне.
	#location ~* /(?:ajax|lib)/.*\.(txt|php)$ {
	#deny all;
	#}
	#location ~* /(?:ajax|arcomage|captcha|chat|class|combat|craft|diary|forum|httpd|inc|info|lib|quest|shop|suggest|suggest_new|userbar|utils|view)/.*\.*$
	#{
	#	return 404;
	#}
# Старое СЗ для Влада
	location /old/
	{
		client_max_body_size 32m;
		alias /var/www/old/;
		location ~ \.php$
		{
			fastcgi_pass old:9000;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $request_filename;
			#fastcgi_param PHP_ADMIN_VALUE "max_execution_time=600";
			fastcgi_param PHP_ADMIN_VALUE "upload_max_filesize=32M \n post_max_size=32M \n error_reporting=E_ALL \n date.timezone=Europe/Moscow";
			include fastcgi_params;
		}
	}
	#Работа с phpMyAdmin 
	#&& кривой ( состоит из фрэймов нескольких php, поэтому не закрыть полностью )
	location /pmx/
	{
		client_max_body_size 32m;
		alias /var/www/phpmyadmin/;
		#http авторизация
		auth_basic "Autorisation required"; 
		auth_basic_user_file /var/www/html/.htpmapwd;
		location ~ \.php$
		{
			fastcgi_pass php:9000;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $request_filename;
			#fastcgi_param PHP_ADMIN_VALUE "max_execution_time=600";
			fastcgi_param PHP_ADMIN_VALUE "upload_max_filesize=32M \n post_max_size=32M \n date.timezone=Europe/Moscow";
			include fastcgi_params;
		}
	}
	#Работа с theia
	location /ide/
	{
		auth_basic "Autorisation required";
		auth_basic_user_file /var/www/html/.htpmapwd;
		proxy_pass http://theia:3000/;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
	}
	location /old-ide/
	{
		auth_basic "Autorisation required";
		auth_basic_user_file /var/www/html/.htpmapwd;
		proxy_pass http://old-theia:3000/;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
	}
	#TODO переделать, чтобы статику отдал другой nginx с поддомена .static.
	location /img/
	{
		alias $root_path/images/;
		try_files $uri =404;
	}
	
	location /styles/
	{
		alias $root_path/styles/;
		try_files $uri =404;
	}
	location /js/
	{
		alias $root_path/js/;
		try_files $uri =404;
	}
}


server
{
	
	listen 443 ssl http2;
	ssl on;
	ssl_certificate /etc/ssl/fullchain.crt;
	ssl_certificate_key /etc/ssl/privkey.key;
	
	#if ($scheme = http) {
	#	rewrite ^(.*) https://$host$1 permanent;
	#}
	
	#хитрый рут через переменную
	server_name middlearth.ru;
		
	set $root_path '/var/www/html';
	root $root_path;
	index index.php;
	error_page 404 /404.html;
	charset utf-8; # Кодировка сервера

	#закрываем доступ к файлу с логином/хэшем пароля
	location ~* /\.ht
	{ 
		return 404;
	}
	#закрытиe выполнения файлов фрэймворка и статики папок
	location ~* /(?:application|system)/.*\.*$
 	{
		return 404;
	}
	location /
	{
		#перенаправляет /контроллер/метод на index.php
		try_files $uri $uri/ /index.php;
	}

	#выполняет, а не предлагает скачать php файл
	location ~ \.php$ 
	{
		try_files $uri =404;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass php:9000;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param PHP_ADMIN_VALUE "upload_max_filesize=4M \n post_max_size=4M \n error_reporting=E_ALL \n date.timezone=Europe/Moscow";
	}

#Закрытие доступа к файлам из вне.
	#location ~* /(?:ajax|lib)/.*\.(txt|php)$ {
	#deny all;
	#}
	#location ~* /(?:ajax|arcomage|captcha|chat|class|combat|craft|diary|forum|httpd|inc|info|lib|quest|shop|suggest|suggest_new|userbar|utils|view)/.*\.*$
	#{
	#	return 404;
	#}
# Старое СЗ для Влада
	location /old/
	{
		client_max_body_size 32m;
		alias /var/www/old/;
		location ~ \.php$
		{
			fastcgi_pass old:9000;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $request_filename;
			#fastcgi_param PHP_ADMIN_VALUE "max_execution_time=600";
			fastcgi_param PHP_ADMIN_VALUE "upload_max_filesize=32M \n post_max_size=32M \n error_reporting=E_ALL \n date.timezone=Europe/Moscow";
			include fastcgi_params;
		}
	}
	#Работа с phpMyAdmin 
	#&& кривой ( состоит из фрэймов нескольких php, поэтому не закрыть полностью )
	location /pmx/
	{
		client_max_body_size 32m;
		alias /var/www/phpmyadmin/;
		#http авторизация
		auth_basic "Autorisation required"; 
		auth_basic_user_file /var/www/html/.htpmapwd;
		location ~ \.php$
		{
			fastcgi_pass php:9000;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $request_filename;
			#fastcgi_param PHP_ADMIN_VALUE "max_execution_time=600";
			fastcgi_param PHP_ADMIN_VALUE "upload_max_filesize=32M \n post_max_size=32M \n date.timezone=Europe/Moscow";
			include fastcgi_params;
		}
	}
	
	
	#rewrite ^/linux/(.*)$ /linux.php?distro=$1 last;
	#linux/centos becomes linux.php?distro=centos
	#Работа с theia
	rewrite ^(/ide/.*)$ /ide/ last;
	location /ide/
	{
		
		auth_basic "Autorisation required";
		auth_basic_user_file /var/www/html/.htpmapwd;
		proxy_pass http://theia:3000/;
		proxy_http_version 1.1;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
	}
	location /old-ide/
	{
		auth_basic "Autorisation required";
		auth_basic_user_file /var/www/html/.htpmapwd;
		proxy_pass http://old-theia:3000/;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
	}
	#TODO переделать, чтобы статику отдал другой nginx с поддомена .static.
	location /img/
	{
		alias $root_path/images/;
		try_files $uri =404;
	}
	
	location /styles/
	{
		alias $root_path/styles/;
		try_files $uri =404;
	}
	location /js/
	{
		alias $root_path/js/;
		try_files $uri =404;
	}
}
